<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

        <script src="../src/L.Deflate.js"></script>
        <style>
            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
            }
            .clusterLabel {
                border-radius: 20px;
                padding: 10px;
                box-shadow: 1px 1px 15px -5px #000000;
            }
            .hasFree { background-color: rgb(181, 226, 140); }
            .onlyReserved { background-color: #ff9b9b; }

            .freeCnt { color: green; font-weight: bold; font-size: 12pt; }
            .reservedCnt { color: #ff1616; font-size: 8pt; }
        </style>
    </head>

    <div id="map"></div>

    <script>


    window.onload = function () {
        const TEXAS_CENTER = [31.616350252730477, -99.20710987096106];
        const HOUSTON_CENTER = [29.732248, -95.398545];
        const GEOJSON_URL = 'https://raw.githubusercontent.com/OpenDataDE/State-zip-code-GeoJSON/master/';
        const state = 'tx_texas';
        const url = GEOJSON_URL + state + '_zip_codes_geo.min.json';
        console.log(url);

        const CLUSTER_ZOOM_LEVEL = 10;

        var map = L.map("map").setView(HOUSTON_CENTER, CLUSTER_ZOOM_LEVEL);

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var polygonLayer = L.layerGroup();
        var markerLayer = L.markerClusterGroup({
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: false,
            showCoverageOnHover: false,
            maxClusterRadius: 120,
            singleMarkerMode: true,

            iconCreateFunction: function (cluster) {
                var markers = cluster.getAllChildMarkers();
                let reservedCnt = 0;

                markers.forEach(marker => {
                    if (marker.options.isReserved) {
                        reservedCnt+= 1;
                    }
                });
                let freeCnt = markers.length - reservedCnt;
                let freeHtml = freeCnt > 0 ? `<div class="freeCnt">${freeCnt} free</div>` : '';
                let reservedHtml = reservedCnt > 0 ? `<div class="reservedCnt">${reservedCnt} reserved</div>` : '';

                let html = `
                    <span style="white-space: nowrap;">
                      ${freeHtml} ${reservedHtml}
                    </span>
                `;

                let classNames = ['clusterLabel'];

                if (freeCnt > 0) {
                    classNames.push('hasFree');
                }
                else if (reservedCnt > 0) {
                    classNames.push('onlyReserved');
                }

                return L.divIcon({
                    html: html,
                    className: classNames.join(' '),
                    iconSize: L.point()
                });
            },

        });

        map.on('zoomend', function () {
            if (map.getZoom() > CLUSTER_ZOOM_LEVEL) {
                map.addLayer(polygonLayer);

                if (map.hasLayer(markerLayer))
                    map.removeLayer(markerLayer);
            }
            else {
                map.addLayer(markerLayer);

                if (map.hasLayer(polygonLayer))
                    map.removeLayer(polygonLayer);
            }
        });
        map.addLayer(markerLayer);

        fetch('polygons.json').then(r => r.json()).then(polys => {
            polys.forEach(poly => {
                L.polygon(poly).addTo(polygonLayer);

                const isReserved = Math.random() > 0.5;
                L.marker(poly[0], { isReserved: isReserved }).addTo(markerLayer);
            });
        });
    }
    </script>
</html>
